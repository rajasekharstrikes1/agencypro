rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && getUserData().role == 'super_admin';
    }
    
    function isTenantAdmin(tenantId) {
      return isAuthenticated() && 
             getUserData().role == 'tenant_admin' && 
             getUserData().tenantId == tenantId;
    }
    
    function isAdminOrEmployee(tenantId) {
      return isAuthenticated() && 
             getUserData().tenantId == tenantId &&
             getUserData().role in ['tenant_admin', 'admin', 'employee'];
    }
    
    function isClientUser(tenantId) {
      return isAuthenticated() && 
             getUserData().tenantId == tenantId &&
             getUserData().role in ['client', 'client_user'];
    }
    
    function belongsToTenant(tenantId) {
      return isAuthenticated() && getUserData().tenantId == tenantId;
    }
    
    function isActiveUser() {
      return isAuthenticated() && getUserData().isActive == true;
    }

    // Users collection - Allow self-registration and management
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Tenants collection - Allow creation during registration
    match /tenants/{tenantId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Subscription Plans - Allow read for all, write for super admin
    match /subscription_plans/{planId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Subscriptions - Allow creation during registration
    match /subscriptions/{subscriptionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Payment Gateway Config - Allow all for now
    match /payment_config/{configId} {
      allow read, write: if isAuthenticated();
    }

    // Discount Codes - Allow all for now
    match /discount_codes/{discountId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Payments - Allow all for authenticated users
    match /payments/{paymentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Leads - Tenant-specific access with proper client isolation
    match /leads/{leadId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Service Options - Tenant-specific
    match /service_options/{serviceId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Status Options - Tenant-specific
    match /status_options/{statusId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // User-specific collections (invoices, customers, settings)
    match /users/{userId}/{collection}/{docId} {
      allow read, write: if isAuthenticated();
    }

    // Invoice counters - User-specific
    match /users/{userId}/invoice_counters/{counterId} {
      allow read, write: if isAuthenticated();
    }

    // System logs - Allow all for now
    match /system_logs/{logId} {
      allow read, write: if isAuthenticated();
    }

    // Analytics - Allow all for now
    match /analytics/{analyticsId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Allow all other documents for authenticated users
    match /{document=**} {
      allow read, write: if isAuthenticated();
    }
  }
}